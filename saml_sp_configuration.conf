# SAML SP Entity IDs - Unique identifiers that identifies the SP to the IdP
keyval_zone zone=keyval_saml_sp_entity_id:1M state=/etc/nginx/conf/keyval/keyval_saml_sp_entity_id.json type=prefix;
keyval $host $saml_sp_entity_id zone=keyval_saml_sp_entity_id;

# SAML SP ACS URL
# SP endpoint that the IdP will send the SAML Response to after successful authentication.
# Can be hardcoded, but need for XML Metadata generation
keyval_zone zone=keyval_saml_sp_acs_url:1M state=/etc/nginx/conf/keyval/saml_sp_acs_url.json type=prefix;
keyval $host $saml_sp_acs_url zone=keyval_saml_sp_acs_url;

# SAML SP Single Logout URL
# SP endpoint that the IdP will send the SAML Logout Request to initiate a logout process.
keyval_zone zone=keyval_saml_sp_slo_url:1M state=/etc/nginx/conf/keyval/saml_sp_slo_url.json type=prefix;
keyval $host $saml_sp_slo_url zone=keyval_saml_sp_slo_url;

# SAML SP Relay State
# Optional parameter that can be used to send additional data along with the SAML authn message.
# Can be used to identify the initial authentication request. For example via NGINX $request_id.
keyval_zone zone=keyval_saml_sp_relay_state:1M state=/etc/nginx/conf/keyval/saml_sp_relay_state.json type=prefix;
keyval $host $saml_sp_relay_state zone=keyval_saml_sp_relay_state;

# SAML SP Signing Certificates
# Maps SP to the certificate file that will be used to sign the AuthnRequest or LogoutRequest sent to the IdP.
keyval_zone zone=keyval_saml_sp_signing_certificate:1M state=/etc/nginx/conf/keyval/saml_sp_signing_certificate.json type=prefix;
keyval $host $saml_sp_signing_certificate zone=keyval_saml_sp_signing_certificate;

# SAML SP Signing Key
# Maps SP to the private key file that will be used to sign the AuthnRequest or LogoutRequest sent to the IdP.
keyval_zone zone=keyval_saml_sp_signing_key:1M state=/etc/nginx/conf/keyval/saml_sp_signing_key.json type=prefix;
keyval $host $saml_sp_signing_key zone=keyval_saml_sp_signing_key;

# SAML SP Force AuthN
# Whether the SP should force re-authentication of the user by the IdP.
# We need to think about what could be a good anchor. Perhaps EU DIGIT will tell us how they use it now.
keyval_zone zone=keyval_saml_sp_force_authn:1M state=/etc/nginx/conf/keyval/saml_sp_force_authn.json type=prefix;
keyval $host $saml_sp_force_authn zone=keyval_saml_sp_force_authn;

# SAML SP NameID format
# Indicates the desired format of the name identifier in the SAML assertion generated by the IdP.
# Section 8.3 of http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf
keyval_zone zone=keyval_saml_sp_nameid_format:1M state=/etc/nginx/conf/keyval/saml_sp_nameid_format.json type=prefix;
keyval $host $saml_sp_nameid_format zone=keyval_saml_sp_nameid_format;

# SAML SP wants signed assertion
# Whether the SP wants the SAML Assertion from the IdP to be digitally signed.
# This is the AuthnRequest parameter that informs the IdP.
keyval_zone zone=keyval_saml_sp_want_signed_assertion:1M state=/etc/nginx/conf/keyval/saml_sp_want_signed_assertion.json type=prefix;
keyval $host $saml_sp_want_signed_assertion zone=keyval_saml_sp_want_signed_assertion;

# SAML idP Entity id
# Unique identifier that identifies the IdP to the SP.
keyval_zone zone=keyval_saml_idp_entity_id:1M state=/etc/nginx/conf/keyval/saml_idp_entity_id.json type=prefix;
keyval $host $saml_idp_entity_id zone=keyval_saml_idp_entity_id;

# SAML idP SSO URL
keyval_zone zone=keyval_saml_idp_sso_url:1M state=/etc/nginx/conf/keyval/saml_idp_sso_url.json type=prefix;
keyval $host $saml_idp_sso_url zone=keyval_saml_idp_sso_url;

# SAML idP verification certificate
keyval_zone zone=keyval_saml_idp_verification_certificate:1M state=/etc/nginx/conf/keyval/saml_idp_verification_certificate.json type=prefix;
keyval $host $saml_idp_verification_certificate zone=keyval_saml_idp_verification_certificate;

# SAML idP Sign AuthN
keyval_zone zone=keyval_saml_idp_sign_authn:1M state=/etc/nginx/conf/keyval/saml_idp_sign_authn.json type=prefix;
keyval $host $saml_idp_sign_authn zone=keyval_saml_idp_sign_authn;

# SAML idP Single Logout URL
keyval_zone zone=keyval_saml_idp_slo_url:1M state=/etc/nginx/conf/keyval/saml_idp_slo_url.json type=prefix;
keyval $host $saml_idp_slo_url zone=keyval_saml_idp_slo_url;

# SAML SP Request binding
# Refers to the method by which an authentication request is sent from
# the SP to an IdP during the Single Sign-On (SSO) process.
# Only HTTP-POST or HTTP-Redirect methods are allowed.
keyval_zone zone=keyval_saml_sp_request_binding:1M state=/etc/nginx/conf/keyval/saml_sp_request_binding.json type=prefix;
keyval $host $saml_sp_request_binding zone=keyval_saml_sp_request_binding;

# SAML cookie flags
keyval_zone zone=keyval_saml_cookie_flags:1M state=/etc/nginx/conf/keyval/saml_cookie_flags.json type=prefix;
keyval $proto $saml_cookie_flags zone=keyval_saml_cookie_flags;

map $http_x_forwarded_proto $proto {
    ""      $scheme;
    default $http_x_forwarded_proto;
}

# ADVANCED CONFIGURATION BELOW THIS LINE
# Additional advanced configuration (server context) in saml_sp.server_conf


######### zones
# Change timeout values to at least the validity period of each token type
keyval_zone zone=saml_authn_storage:1M              state=keyval/saml_authn_storage.json      timeout=5m;
keyval_zone zone=saml_session_access:1M             state=keyval/saml_session_access.json     timeout=1h;
keyval_zone zone=saml_nameid:1M                     state=keyval/saml_nameid.json             timeout=1h;
keyval_zone zone=saml_attrib_uid:1M                 state=keyval/saml_attrib_uid.json         timeout=1h;
keyval_zone zone=saml_attrib_name:1M                state=keyval/saml_attrib_name.json        timeout=1h;
keyval_zone zone=saml_attrib_memberOf:1M            state=keyval/saml_attrib_memberOf.json    timeout=1h;

######### keyvals
keyval $saml_request_id $saml_have_session          zone=saml_authn_storage;      # For initial session creation
keyval $saml_request_id $saml_initial_url           zone=saml_authn_storage;      # For initial session creation

keyval $cookie_auth_token $location_root_granted    zone=saml_session_access;     # keep sesisons
keyval $cookie_auth_token $nameid                   zone=saml_nameid;             # SAML NameID
keyval $cookie_auth_token $uid                      zone=saml_attrib_uid;
keyval $cookie_auth_token $name                     zone=saml_attrib_name;
keyval $cookie_auth_token $memberOf                 zone=saml_attrib_memberOf;

js_import samlsp from saml_sp.js;
js_import deflateRaw from pako.es5.js; # External library for the Deflate function (will be replaced by native zlib support)
